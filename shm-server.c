#include <stdio.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <unistd.h>
#include <getopt.h>
#include <errno.h>
#include <string.h>
#include <stdlib.h>

#include "shm-common.h"
#include "shm-message.h"

#define version "20200228"

void cmHelp();

void cmVersion();

/*Programme principal*/

int main(int argc, char *argv[]){
  shm_message_t *segment_memory = NULL;
  int shmId;
  char *ptr;
  int option_index = 0;
  int opt_long;
  int projId = 1;
  int second = 1;
  int times = -1;
  char *pathname;
  static struct option long_options[] = {
    {"help", no_argument, 0, 'h'},
    {"key-proj-id", required_argument, 0, 'i'},
    {"key-pathname", required_argument, 0, 'p'},
    {"seconds", required_argument, 0, 's'},
    {"times", required_argument, 0, 't'},
    {"version", no_argument, 0, 'v'},
    {0, 0, 0, 0}
  };
  pathname = NULL;
  while ((opt_long = getopt_long(argc, argv, "hi:p:s:t:v", long_options, &option_index)) != -1){
    switch(opt_long){
      case 'h':
        cmHelp();
        return 0;
        break;
      case 'v':
        cmVersion();
        return 0;
        break;
      case 'i':
        if(optarg){
          projId = strtol(optarg, &ptr, 10);
          if((errno != 0) || (*ptr != '\0')){
            fprintf(stderr, "%s: Invalid parameter for the i command\n", argv[0]);
            return 1;
          }
        }
        break;
      case 's':
        if(optarg){
          second = strtol(optarg, &ptr, 10);
          if((errno != 0) || (*ptr != '\0')){
            fprintf(stderr, "%s: Invalid parameter for the s command\n", argv[0]);
            return 1;
          }
        }
        break;
      case 't':
        if(optarg){
          times = strtol(optarg, &ptr, 10);
          if((errno != 0) || (*ptr != '\0')){
            fprintf(stderr, "%s: Invalid parameter for the t command\n", argv[0]);
            return 1;
          }
        }
        break;
      case 'p':
        if(optarg){
          pathname = optarg;
        }
        break;
      case '?':
        return 1;
      }
  }
  fprintf(stdout, "proj_id = \"%d\"\n", projId);
  if(pathname == NULL){
    fprintf(stdout, "pathname = \"file.ftok\"\n");
  }else{
    fprintf(stdout, "pathname = \"%s\"\n", pathname);
  }

  if(pathname != NULL){
    segment_memory = link_to_memory(pathname, projId, "server", &shmId);
    if(segment_memory == NULL){
      return 1;
    }
  }else{
    segment_memory = link_to_memory("file.ftok", projId, "server", &shmId);
    if(segment_memory == NULL){
      return 1;
    }
  }

  while(times != 0){
    if(times > 0){
      times --;
    }
    if(!shm_message_is_empty(*segment_memory)){
      shm_message_print(*segment_memory);
      shm_message_empty(segment_memory);
    }
    if(second > 0){
      if(times != 0){
        sleep(second);
      }
    }else{
      fprintf(stdout, "Press the Enter key to continue...");
      while ((getchar()) != '\n');
    }
  }
  if(shmctl(shmId, IPC_RMID, NULL) == -1){
    fprintf(stderr, "%s: unable to destroy the segment memory\n", argv[0]);
    return 1;
  }
  return 0;
}


void cmHelp(){
  fprintf(stdout, "Usage: ./shm-server.out [OPTION]...\n");
  fprintf(stdout, "Receive messages from clients through shared memory.\n");
  fprintf(stdout, "\nOptions:\n");
  fprintf(stdout, "\t-h, --help\n");
  fprintf(stdout, "\t\tdisplay this help and exit\n");
  fprintf(stdout, "\t-i, --key-proj-id=PROJ_ID\n");
  fprintf(stdout, "\t\tset the key project identifier to PROJ_ID (the default value is \"1\")\n");
  fprintf(stdout, "\t-p, --key-pathname=PATHNAME\n");
  fprintf(stdout, "\t\tset the key pathname to PATHNAME (the default value is \"file.ftok\")\n");
  fprintf(stdout, "\t-s, --seconds=SECONDS\n");
  fprintf(stdout, "\t\tset the seconds between each try (the default value is \"1\", a value less than or equal to 0 enables the interactive mode where the input stream is read)\n");
  fprintf(stdout, "\t-t, --times=TIMES\n");
  fprintf(stdout, "\t\tset the number of times this program tries to send a message (the default value is \"1\", a negative value means repeat for ever)\n");
  fprintf(stdout, "\t-v, --version\n");
  fprintf(stdout, "\t\toutput version information and exit\n");
  fprintf(stdout, "\nReport bugs to Benjamin Coppens Bioux <benjamin.coppens-bioux@etud.univ-pau.fr> and liam Didriche <liam.didriche@etud.univ-pau.fr>.\n");
}

void cmVersion(){
  fprintf(stdout, "shm-server %s\n", version);
  fprintf(stdout, "\nCopyright (C) 2020 Benjamin Coppens Bioux and liam Didriche.\n");
  fprintf(stdout, "\nWritten by Benjamin Coppens Bioux <benjamin.coppens-bioux@etud.univ-pau.fr> and liam Didriche <liam.didriche@etud.univ-pau.fr>.\n");
}
