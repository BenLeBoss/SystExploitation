#include <stdio.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <string.h>

#include "shm-common.h"
#include "shm-message.h"


/*d√©finition des sous-programmes communs*/


void *link_to_memory(const char *pathname, int proj_id, char *user){
  void *result = NULL;
  int shmId;
  key_t key = ftok(pathname, proj_id);
  if(key == -1){
    fprintf(stderr, "./shm-%s.out:shm-common.c:15: Unable to create the System V IPC key from the \"%s\"pathname and the \"%d\" project identifier.\n", user, pathname, proj_id);
    return result;
  }
  printf("%ld\n", sizeof(shm_message_t));
  if(!strcmp(user, "server")){
    shmId = shmget(key, sizeof(shm_message_t), IPC_EXCL | IPC_CREAT | 0600);
  }else if(!strcmp(user, "client")){
    shmId = shmget(key, sizeof(shm_message_t), 0);
  }else{
    fprintf(stderr, "Goulag pour ta famille %s", user);
  }
  if(shmId == -1){
    fprintf(stderr, "./shm-%s.out:shm-common.c:20: Unable to get the identifier of the System V shared memorysegment from the \"0x%08x\" key.\n", user, key);
    return result;
  }
  printf("shmId:%d\n", shmId);
  result = shmat(shmId, NULL, 0);
  if(result == (void *) -1){
    fprintf(stderr, "./shm-%s.out:shm-common.c:25: Unable to attach to the segment memory\n", user);
    return NULL;
  }
  return result;
}
