#include <stdio.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <unistd.h>
#include <getopt.h>
#include <errno.h>
#include <string.h>
#include <stdlib.h>

#include "shm-common.h"
#include "shm-message.h"

#define version "20200226"


/*Déclaration des sous-programmes*/


void cmHelp();

void cmVersion();


/*Programme principal*/

int main(int argc, char *argv[]){
  int test = 0;
  char *ptr;
  char *messageName = "Default name";
  char *messageText = "This is the default message text";
  char *pathname = "./File.ftok";
  shm_message_t message;
  int projId = 1;
  shm_message_t *segment_memory = NULL;
  int option_index = 0;
  int opt_long;
  static struct option long_options[] = {
    {"help", no_argument, 0, 'h'},
    {"key-proj-id", required_argument, 0, 'i'},
    {"message-name", required_argument, 0, 'n'},
    {"key-pathname", required_argument, 0, 'p'},
    {"seconds", required_argument, 0, 's'},
    {"times", required_argument, 0, 't'},
    {"version", no_argument, 0, 'v'},
    {"message-text", required_argument, 0, 'x'},
    {0, 0, 0, 0}
 };

 shm_message_set_name(&message, messageName);
 shm_message_set_text(&message, messageText);

  /*Options*/


  while ((opt_long = getopt_long(argc, argv, "hi:n:p:s:t:vx:", long_options, &option_index)) != -1){
      switch(opt_long){
        case 'h':
          cmHelp();
          break;
        case 'v':
          cmVersion();
          break;
        case 'i':
          if(optarg){
            projId = strtol(optarg, &ptr, 10);
            if((errno != 0) || (*ptr != '\0')){
              fprintf(stderr, "%s: Invalid parameter for the i command\n", argv[0]);
            }
          }
          break;
        case 'n':
          shm_message_set_name(&message, optarg);
          break;
        case 'x':
          shm_message_set_text(&message, optarg);
          break;
        case '?':
          return -1;
        default:
          printf("Commande: %d\n", opt_long);
          printf("Paramètre: %s\n", optarg);
      }

  }


  /*Fin des options*/

  /*Connexion au segment de mémoire*/

  segment_memory = link_to_memory(pathname, projId, "client");
  printf("%d\n", test);
  test++;

  /*Ecriture du message*/

  shm_message_print(message);
  shm_message_copy(message, segment_memory);
  shm_message_print(*segment_memory);

  return 0;
}


/*Définition des sous-programmes*/


void cmHelp(){
  printf("Usage: ./shm-client.out [OPTION]...\n");
  printf("Send a message to a server through shared memory.\n");
  printf("\nOptions:\n");
  printf("\t-h, --help\n");
  printf("\t\tdisplay this help and exit\n");
  printf("\t-i, --key-proj-id=PROJ_ID\n");
  printf("\t\tset the key project identifier to PROJ_ID (the default value is \"1\")\n");
  printf("\t-n, --message-name=NAME\n");
  printf("\t\tset the message name to NAME (the default value is \"Default name\")\n");
  printf("\t-p, --key-pathname=PATHNAME\n");
  printf("\t\tset the key pathname to PATHNAME (the default value is \"file.ftok\")\n");
  printf("\t-s, --seconds=SECONDS\n");
  printf("\t\tset the seconds between each try (the default value is \"1\", a value less than orequal to 0 enables the interactive mode where the input stream is read)\n");
  printf("\t-t, --times=TIMES\n");
  printf("\t\tset the number of times this program tries to send a message (the default value is \"1\", a negative value means repeat for ever)\n");
  printf("\t-v, --version\n");
  printf("\t\toutput version information and exit\n");
  printf("\t-x, --message-text=TEXT\n");
  printf("\t\tset the message text to TEXT (the default value is \"This is the default messagetext\")\n");
  printf("\nReport bugs to Mauro Gaio <mauro.gaio@univ-pau.fr> and Samson Pierre <samson.pierre@univ-pau.fr>.\n");
}

void cmVersion(){
  printf("shm-client %s\n", version);
  printf("\nCopyright (C) 2020 Mauro Gaio and Samson Pierre.\n");
  printf("\nWritten by Mauro Gaio <mauro.gaio@univ-pau.fr> and Samson Pierre <samson.pierre@univ-pau.fr>.\n");
}
